<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="profile.pageTitle">ä¸ªäººä¸»é¡µ | åä¾¦æ¢ä½œä¸šå¸®</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neonCyan: '#00d4ff',
                        detectiveGold: '#ffd700',
                        mysteryBlack: '#1a1a2e',
                        moonlightBlue: '#16213e',
                    }
                }
            }
        }
    </script>

    <style>
        .profile-card {
            background: linear-gradient(135deg, rgba(22, 33, 62, 0.9) 0%, rgba(26, 26, 46, 0.95) 100%);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: rgba(0, 212, 255, 0.3);
            transform: translateY(-2px);
        }

        .menu-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .menu-item:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: rgba(0, 212, 255, 0.3);
            transform: translateX(4px);
        }

        .avatar-ring {
            background: linear-gradient(135deg, #00d4ff 0%, #ffd700 100%);
            padding: 3px;
            border-radius: 50%;
        }

        .avatar-inner {
            background: #1a1a2e;
            border-radius: 50%;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .diary-preview {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .diary-preview:hover {
            border-color: rgba(0, 212, 255, 0.3);
        }

        /* ç›®æ ‡å¡ç‰‡æ ·å¼ */
        .goal-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .goal-item:hover {
            border-color: rgba(255, 215, 0, 0.3);
        }

        .goal-item.completed {
            opacity: 0.6;
        }

        .goal-item.completed .goal-title {
            text-decoration: line-through;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(22, 33, 62, 0.98) 0%, rgba(26, 26, 46, 0.98) 100%);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 16px;
        }

        .goal-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            transition: all 0.3s ease;
        }

        .goal-input:focus {
            outline: none;
            border-color: rgba(0, 212, 255, 0.5);
            box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.1);
        }

        .goal-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        /* è¯­è¨€åˆ‡æ¢æ ·å¼ */
        .lang-switcher .lang-btn {
            opacity: 0.6;
            transition: all 0.3s ease;
        }
        .lang-switcher .lang-btn:hover,
        .lang-switcher .lang-btn.active {
            opacity: 1;
            color: #00d4ff;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-mysteryBlack via-moonlightBlue to-mysteryBlack text-white">

    <!-- æ˜Ÿæ˜ŸèƒŒæ™¯ -->
    <div class="stars" id="stars"></div>

    <!-- å¯¼èˆªæ  -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-mysteryBlack/80 backdrop-blur-md border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="/" class="flex items-center gap-3">
                    <i class="fa-solid fa-magnifying-glass text-neonCyan text-xl"></i>
                    <span class="text-xl font-bold bg-gradient-to-r from-neonCyan to-detectiveGold bg-clip-text text-transparent" data-i18n="common.appName">åä¾¦æ¢ä½œä¸šå¸®</span>
                </a>
                <div class="flex items-center gap-4">
                    <!-- è¯­è¨€åˆ‡æ¢ -->
                    <div class="lang-switcher flex items-center gap-1 text-sm">
                        <button data-lang="zh-CN" class="lang-btn px-2 py-1 rounded hover:text-neonCyan transition-colors">ä¸­æ–‡</button>
                        <span class="text-white/30">|</span>
                        <button data-lang="en-US" class="lang-btn px-2 py-1 rounded hover:text-neonCyan transition-colors">EN</button>
                    </div>
                    <a href="/app" class="text-white/70 hover:text-neonCyan transition-colors">
                        <i class="fa-solid fa-brain mr-1"></i>
                        <span data-i18n="common.qaApp">æ™ºèƒ½é—®ç­”</span>
                    </a>
                    <button onclick="logout()" class="text-white/70 hover:text-conanRed transition-colors">
                        <i class="fa-solid fa-sign-out-alt mr-1"></i>
                        <span data-i18n="common.logout">é€€å‡º</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main class="pt-24 pb-12 px-4">
        <div class="max-w-2xl mx-auto">

            <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
            <div class="profile-card p-6 mb-6">
                <div class="flex items-center gap-4 mb-6">
                    <!-- å¤´åƒ -->
                    <div class="avatar-ring w-20 h-20">
                        <div class="avatar-inner">
                            <i class="fa-solid fa-user-secret text-3xl text-detectiveGold"></i>
                        </div>
                    </div>
                    <!-- ç”¨æˆ·ä¿¡æ¯ -->
                    <div class="flex-1">
                        <h1 id="profileName" class="text-2xl font-bold mb-1">ç”¨æˆ·</h1>
                        <p id="profileEmail" class="text-white/50 text-sm">
                            <i class="fa-solid fa-envelope mr-1"></i>
                            <span>loading...</span>
                        </p>
                        <p id="profileJoinDate" class="text-white/50 text-sm mt-1">
                            <i class="fa-solid fa-calendar mr-1"></i>
                            <span data-i18n="profile.memberSince">åŠ å…¥æ—¶é—´</span>: <span id="joinDate">-</span>
                        </p>
                    </div>
                </div>

                <!-- ç»Ÿè®¡æ•°æ® -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="stat-card p-4 text-center">
                        <div class="text-3xl font-bold text-neonCyan mb-1" id="diaryCount">0</div>
                        <div class="text-white/50 text-sm" data-i18n="profile.totalDiaries">æ—¥è®°æ€»æ•°</div>
                    </div>
                    <div class="stat-card p-4 text-center">
                        <div class="text-3xl font-bold text-detectiveGold mb-1" id="streakCount">0</div>
                        <div class="text-white/50 text-sm" data-i18n="profile.streakDays">è¿ç»­å¤©æ•°</div>
                    </div>
                    <div class="stat-card p-4 text-center">
                        <div class="text-3xl font-bold text-green-400 mb-1" id="todayStatus">
                            <i class="fa-solid fa-circle-xmark"></i>
                        </div>
                        <div class="text-white/50 text-sm" data-i18n="profile.todayDiary">ä»Šæ—¥æ‰“å¡</div>
                    </div>
                </div>
            </div>

            <!-- åŠŸèƒ½èœå• -->
            <div class="profile-card p-6 mb-6">
                <h2 class="text-lg font-bold mb-4">
                    <i class="fa-solid fa-compass text-neonCyan mr-2"></i>
                    <span data-i18n="profile.quickAccess">å¿«æ·å…¥å£</span>
                </h2>
                <div class="space-y-3">
                    <!-- å†™æ—¥è®° -->
                    <a href="/diary" class="menu-item p-4 flex items-center gap-4 block">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-neonCyan to-detectiveGold flex items-center justify-center">
                            <i class="fa-solid fa-feather-pointed text-mysteryBlack text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold" data-i18n="profile.writeDiary">å†™æ—¥è®°</div>
                            <div class="text-white/50 text-sm" data-i18n="profile.writeDiaryDesc">è®°å½•ä»Šå¤©çš„å¿ƒæƒ…å’Œæ•…äº‹</div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-white/30"></i>
                    </a>

                    <!-- è®¾ç½®ç›®æ ‡ - æ˜¾çœ¼ä½ç½® -->
                    <button onclick="showAddGoalModal()" class="menu-item p-4 flex items-center gap-4 w-full text-left">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-yellow-500 to-orange-500 flex items-center justify-center">
                            <i class="fa-solid fa-bullseye text-white text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold" data-i18n="profile.setGoals">è®¾ç½®ç›®æ ‡</div>
                            <div class="text-white/50 text-sm" data-i18n="profile.setGoalsDesc">åˆ¶å®šç›®æ ‡ï¼ŒAIå¸®ä½ è¿½è¸ªè¿›åº¦</div>
                        </div>
                        <i class="fa-solid fa-plus text-detectiveGold"></i>
                    </button>

                    <!-- æ—¥è®°å†å² -->
                    <a href="/diary/list" class="menu-item p-4 flex items-center gap-4 block">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center">
                            <i class="fa-solid fa-book text-white text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold" data-i18n="profile.diaryHistory">æ—¥è®°å†å²</div>
                            <div class="text-white/50 text-sm" data-i18n="profile.diaryHistoryDesc">æŸ¥çœ‹æ‰€æœ‰æ—¥è®°è®°å½•</div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-white/30"></i>
                    </a>

                    <!-- æ™ºèƒ½é—®ç­” -->
                    <a href="/app" class="menu-item p-4 flex items-center gap-4 block">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center">
                            <i class="fa-solid fa-brain text-white text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold" data-i18n="profile.qaApp">æ™ºèƒ½é—®ç­”</div>
                            <div class="text-white/50 text-sm" data-i18n="profile.qaAppDesc">AIå¸®ä½ è§£ç­”å­¦ä¹ é—®é¢˜</div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-white/30"></i>
                    </a>
                </div>
            </div>

            <!-- æˆ‘çš„ç›®æ ‡ -->
            <div class="profile-card p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold">
                        <i class="fa-solid fa-bullseye text-detectiveGold mr-2"></i>
                        <span data-i18n="goals.myGoals">æˆ‘çš„ç›®æ ‡</span>
                    </h2>
                    <button onclick="showAddGoalModal()" class="text-neonCyan text-sm hover:underline flex items-center gap-1">
                        <i class="fa-solid fa-plus"></i>
                        <span data-i18n="goals.addGoal">æ·»åŠ ç›®æ ‡</span>
                    </button>
                </div>

                <div id="goalsList" class="space-y-3">
                    <!-- åŠ¨æ€åŠ è½½ç›®æ ‡åˆ—è¡¨ -->
                </div>

                <div id="noGoals" class="hidden text-center py-8">
                    <i class="fa-solid fa-bullseye text-4xl text-white/20 mb-3"></i>
                    <p class="text-white/50 mb-2" data-i18n="goals.noGoals">è¿˜æ²¡æœ‰è®¾å®šç›®æ ‡</p>
                    <p class="text-white/30 text-sm mb-4" data-i18n="goals.noGoalsDesc">è®¾å®šç›®æ ‡åï¼ŒAIä¼šåœ¨æ—¥è®°ä¸­å¸®ä½ è¿½è¸ªè¿›åº¦</p>
                    <button onclick="showAddGoalModal()" class="inline-block px-6 py-2 rounded-lg bg-gradient-to-r from-neonCyan to-detectiveGold text-mysteryBlack font-bold">
                        <i class="fa-solid fa-plus mr-2"></i>
                        <span data-i18n="goals.addFirst">æ·»åŠ ç¬¬ä¸€ä¸ªç›®æ ‡</span>
                    </button>
                </div>
            </div>

            <!-- æœ€è¿‘æ—¥è®° -->
            <div class="profile-card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold">
                        <i class="fa-solid fa-clock-rotate-left text-detectiveGold mr-2"></i>
                        <span data-i18n="profile.recentDiaries">æœ€è¿‘æ—¥è®°</span>
                    </h2>
                    <a href="/diary/list" class="text-neonCyan text-sm hover:underline" data-i18n="profile.viewAll">æŸ¥çœ‹å…¨éƒ¨</a>
                </div>

                <div id="recentDiaries" class="space-y-3">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </div>

                <div id="noDiaries" class="hidden text-center py-8">
                    <i class="fa-solid fa-book-open text-4xl text-white/20 mb-3"></i>
                    <p class="text-white/50" data-i18n="profile.noDiaries">è¿˜æ²¡æœ‰æ—¥è®°ï¼Œå¼€å§‹è®°å½•å§ï¼</p>
                    <a href="/diary" class="inline-block mt-4 px-6 py-2 rounded-lg bg-gradient-to-r from-neonCyan to-detectiveGold text-mysteryBlack font-bold">
                        <i class="fa-solid fa-pen mr-2"></i>
                        <span data-i18n="profile.startWriting">å†™ç¬¬ä¸€ç¯‡</span>
                    </a>
                </div>
            </div>

        </div>
    </main>

    <!-- æ·»åŠ /ç¼–è¾‘ç›®æ ‡æ¨¡æ€æ¡† -->
    <div id="goalModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="hideGoalModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content relative p-6 max-w-md w-full">
                <h3 id="goalModalTitle" class="text-xl font-bold mb-4 text-center">
                    <i class="fa-solid fa-bullseye text-detectiveGold mr-2"></i>
                    <span data-i18n="goals.addGoal">æ·»åŠ ç›®æ ‡</span>
                </h3>

                <form id="goalForm" onsubmit="saveGoal(event)">
                    <input type="hidden" id="goalId" value="">

                    <div class="mb-4">
                        <label class="block text-white/70 text-sm mb-2" data-i18n="goals.goalTitle">ç›®æ ‡æ ‡é¢˜</label>
                        <input type="text" id="goalTitle" class="goal-input w-full px-4 py-3"
                               placeholder="ä¾‹å¦‚ï¼šæ¯å¤©é˜…è¯»30åˆ†é’Ÿ" data-i18n-placeholder="goals.titlePlaceholder" required maxlength="255">
                    </div>

                    <div class="mb-6">
                        <label class="block text-white/70 text-sm mb-2" data-i18n="goals.goalDescription">ç›®æ ‡æè¿°ï¼ˆé€‰å¡«ï¼‰</label>
                        <textarea id="goalDescription" class="goal-input w-full px-4 py-3 h-24 resize-none"
                                  placeholder="æè¿°ä½ æƒ³è¾¾æˆçš„å…·ä½“ç›®æ ‡..." data-i18n-placeholder="goals.descriptionPlaceholder"></textarea>
                    </div>

                    <div class="flex gap-4">
                        <button type="button" onclick="hideGoalModal()"
                                class="flex-1 py-3 rounded-lg border border-white/20 text-white/70 hover:bg-white/10 transition-colors">
                            <span data-i18n="common.cancel">å–æ¶ˆ</span>
                        </button>
                        <button type="submit"
                                class="flex-1 py-3 rounded-lg bg-gradient-to-r from-neonCyan to-detectiveGold text-mysteryBlack font-bold">
                            <i class="fa-solid fa-check mr-2"></i>
                            <span data-i18n="common.confirm">ç¡®è®¤</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="deleteGoalModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="hideDeleteGoalModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content relative p-6 max-w-sm w-full">
                <h3 class="text-xl font-bold mb-4 text-center">
                    <i class="fa-solid fa-exclamation-triangle text-red-500 mr-2"></i>
                    <span data-i18n="goals.deleteConfirmTitle">ç¡®è®¤åˆ é™¤</span>
                </h3>
                <p class="text-white/70 text-center mb-6" data-i18n="goals.deleteConfirmMessage">
                    ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç›®æ ‡å—ï¼Ÿ
                </p>
                <div class="flex gap-4">
                    <button onclick="hideDeleteGoalModal()"
                            class="flex-1 py-3 rounded-lg border border-white/20 text-white/70 hover:bg-white/10 transition-colors">
                        <span data-i18n="common.cancel">å–æ¶ˆ</span>
                    </button>
                    <button onclick="confirmDeleteGoal()"
                            class="flex-1 py-3 rounded-lg bg-red-500 text-white font-bold hover:bg-red-600 transition-colors">
                        <i class="fa-solid fa-trash-alt mr-2"></i>
                        <span data-i18n="common.confirm">ç¡®è®¤</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å›½é™…åŒ–æ”¯æŒ -->
    <script src="{{ url_for('static', filename='js/translations/zh-CN.js') }}"></script>
    <script src="{{ url_for('static', filename='js/translations/en-US.js') }}"></script>
    <script src="{{ url_for('static', filename='js/i18n.js') }}"></script>

    <script>
        const moodEmojis = ['', 'ğŸ˜¢', 'ğŸ˜•', 'ğŸ˜', 'ğŸ˜Š', 'ğŸ˜„'];

        // ç”Ÿæˆæ˜Ÿæ˜ŸèƒŒæ™¯
        function createStars() {
            const container = document.getElementById('stars');
            if (!container) return;
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.width = Math.random() * 3 + 1 + 'px';
                star.style.height = star.style.width;
                container.appendChild(star);
            }
        }

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/auth/user');
                const data = await response.json();

                if (!data.logged_in) {
                    window.location.href = '/login';
                    return;
                }

                document.getElementById('profileName').textContent = data.user.name;

                const emailEl = document.getElementById('profileEmail');
                if (data.user.email) {
                    emailEl.innerHTML = `<i class="fa-solid fa-envelope mr-1"></i>${data.user.email}`;
                } else if (data.user.phone) {
                    emailEl.innerHTML = `<i class="fa-solid fa-phone mr-1"></i>${data.user.phone}`;
                } else {
                    emailEl.classList.add('hidden');
                }

            } catch (error) {
                console.error('Load user info error:', error);
                window.location.href = '/login';
            }
        }

        // åŠ è½½æ—¥è®°ç»Ÿè®¡
        async function loadDiaryStats() {
            try {
                // åŠ è½½æ—¥è®°åˆ—è¡¨è·å–æ€»æ•°
                const diariesRes = await fetch('/api/diaries?limit=1&offset=0');
                const diariesData = await diariesRes.json();
                if (diariesData.success) {
                    document.getElementById('diaryCount').textContent = diariesData.total;
                }

                // åŠ è½½è¿ç»­å¤©æ•°
                const streakRes = await fetch('/api/diary/streak');
                const streakData = await streakRes.json();
                document.getElementById('streakCount').textContent = streakData.streak || 0;

                // æ£€æŸ¥ä»Šæ—¥çŠ¶æ€
                const todayRes = await fetch('/api/diary/status/today');
                const todayData = await todayRes.json();
                const todayEl = document.getElementById('todayStatus');
                if (todayData.has_diary) {
                    todayEl.innerHTML = '<i class="fa-solid fa-circle-check text-green-400"></i>';
                } else {
                    todayEl.innerHTML = '<i class="fa-solid fa-circle-xmark text-white/30"></i>';
                }

            } catch (error) {
                console.error('Load diary stats error:', error);
            }
        }

        // åŠ è½½æœ€è¿‘æ—¥è®°
        async function loadRecentDiaries() {
            try {
                const response = await fetch('/api/diaries?limit=3&offset=0');
                const data = await response.json();

                const container = document.getElementById('recentDiaries');
                const noDiaries = document.getElementById('noDiaries');

                if (!data.success || data.diaries.length === 0) {
                    container.classList.add('hidden');
                    noDiaries.classList.remove('hidden');
                    return;
                }

                container.innerHTML = '';
                data.diaries.forEach(diary => {
                    const date = new Date(diary.created_at);
                    const dateStr = date.toLocaleDateString('zh-CN', {
                        month: 'short', day: 'numeric'
                    });

                    const preview = diary.content.length > 60
                        ? diary.content.substring(0, 60) + '...'
                        : diary.content;

                    const card = document.createElement('a');
                    card.href = `/diary/${diary.id}`;
                    card.className = 'diary-preview p-4 flex items-center gap-3 block';
                    card.innerHTML = `
                        <div class="text-2xl">${moodEmojis[diary.mood_score] || 'ğŸ“'}</div>
                        <div class="flex-1 min-w-0">
                            <div class="text-white/50 text-xs mb-1">${dateStr}</div>
                            <div class="text-white/90 text-sm truncate">${preview}</div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-white/30"></i>
                    `;
                    container.appendChild(card);
                });

            } catch (error) {
                console.error('Load recent diaries error:', error);
            }
        }

        // ç™»å‡º
        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // ==================== ç›®æ ‡ç®¡ç†åŠŸèƒ½ ====================
        let deleteGoalId = null;

        // åŠ è½½ç›®æ ‡åˆ—è¡¨
        async function loadGoals() {
            const container = document.getElementById('goalsList');
            const noGoals = document.getElementById('noGoals');

            try {
                const response = await fetch('/api/goals');
                const data = await response.json();

                if (!data.success || !data.goals || data.goals.length === 0) {
                    container.classList.add('hidden');
                    noGoals.classList.remove('hidden');
                    return;
                }

                container.classList.remove('hidden');
                noGoals.classList.add('hidden');

                container.innerHTML = '';
                data.goals.forEach(goal => {
                    const card = document.createElement('div');
                    card.className = `goal-item p-4 ${goal.status === 'completed' ? 'completed' : ''}`;
                    card.innerHTML = `
                        <div class="flex items-start gap-3">
                            <button onclick="toggleGoalStatus(${goal.id}, '${goal.status}')"
                                    class="mt-1 w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 transition-colors ${goal.status === 'completed' ? 'bg-green-500 border-green-500' : 'border-white/30 hover:border-detectiveGold'}">
                                ${goal.status === 'completed' ? '<i class="fa-solid fa-check text-white text-xs"></i>' : ''}
                            </button>
                            <div class="flex-1 min-w-0">
                                <div class="goal-title font-bold text-white/90">${escapeHtml(goal.title)}</div>
                                ${goal.description ? `<div class="text-white/50 text-sm mt-1">${escapeHtml(goal.description)}</div>` : ''}
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0">
                                <button onclick="editGoal(${goal.id})" class="text-white/30 hover:text-neonCyan transition-colors p-1">
                                    <i class="fa-solid fa-pen text-sm"></i>
                                </button>
                                <button onclick="showDeleteGoalModal(${goal.id})" class="text-white/30 hover:text-red-500 transition-colors p-1">
                                    <i class="fa-solid fa-trash-alt text-sm"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });

            } catch (error) {
                console.error('Load goals error:', error);
                // å‡ºé”™æ—¶ä¹Ÿæ˜¾ç¤ºç©ºçŠ¶æ€ï¼Œè®©ç”¨æˆ·å¯ä»¥æ·»åŠ ç›®æ ‡
                container.classList.add('hidden');
                noGoals.classList.remove('hidden');
            }
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ˜¾ç¤ºæ·»åŠ ç›®æ ‡æ¨¡æ€æ¡†
        function showAddGoalModal() {
            document.getElementById('goalId').value = '';
            document.getElementById('goalTitle').value = '';
            document.getElementById('goalDescription').value = '';
            document.getElementById('goalModalTitle').innerHTML = '<i class="fa-solid fa-bullseye text-detectiveGold mr-2"></i><span data-i18n="goals.addGoal">æ·»åŠ ç›®æ ‡</span>';
            document.getElementById('goalModal').classList.remove('hidden');
            document.getElementById('goalTitle').focus();
            // é‡æ–°åº”ç”¨i18n
            if (window.i18n) window.i18n.updatePageTranslations();
        }

        // ç¼–è¾‘ç›®æ ‡
        async function editGoal(goalId) {
            try {
                const response = await fetch(`/api/goal/${goalId}`);
                const data = await response.json();

                if (!data.success) {
                    alert('ç›®æ ‡ä¸å­˜åœ¨');
                    return;
                }

                document.getElementById('goalId').value = data.goal.id;
                document.getElementById('goalTitle').value = data.goal.title;
                document.getElementById('goalDescription').value = data.goal.description || '';
                document.getElementById('goalModalTitle').innerHTML = '<i class="fa-solid fa-pen text-detectiveGold mr-2"></i><span data-i18n="goals.editGoal">ç¼–è¾‘ç›®æ ‡</span>';
                document.getElementById('goalModal').classList.remove('hidden');
                document.getElementById('goalTitle').focus();
                if (window.i18n) window.i18n.updatePageTranslations();
            } catch (error) {
                console.error('Edit goal error:', error);
            }
        }

        // éšè—ç›®æ ‡æ¨¡æ€æ¡†
        function hideGoalModal() {
            document.getElementById('goalModal').classList.add('hidden');
        }

        // ä¿å­˜ç›®æ ‡
        async function saveGoal(event) {
            event.preventDefault();

            const goalId = document.getElementById('goalId').value;
            const title = document.getElementById('goalTitle').value.trim();
            const description = document.getElementById('goalDescription').value.trim();

            if (!title) {
                alert('è¯·è¾“å…¥ç›®æ ‡æ ‡é¢˜');
                return;
            }

            try {
                let response;
                if (goalId) {
                    // æ›´æ–°
                    response = await fetch(`/api/goal/${goalId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, description })
                    });
                } else {
                    // åˆ›å»º
                    response = await fetch('/api/goals', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, description })
                    });
                }

                const data = await response.json();
                if (data.success) {
                    hideGoalModal();
                    loadGoals();
                } else {
                    alert(data.message || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('Save goal error:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åˆ‡æ¢ç›®æ ‡çŠ¶æ€
        async function toggleGoalStatus(goalId, currentStatus) {
            const newStatus = currentStatus === 'completed' ? 'active' : 'completed';

            try {
                const response = await fetch(`/api/goal/${goalId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                const data = await response.json();
                if (data.success) {
                    loadGoals();
                } else {
                    alert(data.message || 'æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                console.error('Toggle goal status error:', error);
            }
        }

        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
        function showDeleteGoalModal(goalId) {
            deleteGoalId = goalId;
            document.getElementById('deleteGoalModal').classList.remove('hidden');
        }

        // éšè—åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
        function hideDeleteGoalModal() {
            deleteGoalId = null;
            document.getElementById('deleteGoalModal').classList.add('hidden');
        }

        // ç¡®è®¤åˆ é™¤ç›®æ ‡
        async function confirmDeleteGoal() {
            if (!deleteGoalId) return;

            try {
                const response = await fetch(`/api/goal/${deleteGoalId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    hideDeleteGoalModal();
                    loadGoals();
                } else {
                    alert(data.message || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('Delete goal error:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            createStars();
            loadUserInfo();
            loadDiaryStats();
            loadRecentDiaries();
            loadGoals();
        });
    </script>
</body>
</html>
