<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="diary.detailPageTitle">æ—¥è®°è¯¦æƒ… | è¨€ç®€æ„èµ…</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdownæ¸²æŸ“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/diary-pages.css') }}">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neonCyan: '#00d4ff',
                        detectiveGold: '#ffd700',
                        mysteryBlack: '#1a1a2e',
                        moonlightBlue: '#16213e',
                        conanRed: '#E31D2B',
                    }
                }
            }
        }
    </script>

    <style>
        .mood-display {
            font-size: 48px;
            line-height: 1;
        }

        .diary-content {
            white-space: pre-wrap;
            line-height: 1.8;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-mysteryBlack via-moonlightBlue to-mysteryBlack text-white">

    <!-- å¯¼èˆªæ  -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-mysteryBlack/80 backdrop-blur-md border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="/" class="flex items-center gap-3">
                    <i class="fa-solid fa-magnifying-glass text-neonCyan text-xl"></i>
                    <span class="text-xl font-bold bg-gradient-to-r from-neonCyan to-detectiveGold bg-clip-text text-transparent" data-i18n="common.appName">è¨€ç®€æ„èµ…</span>
                </a>
                <div class="flex items-center gap-4">
                    <!-- è¯­è¨€åˆ‡æ¢ -->
                    <div class="dp-lang-switcher flex items-center gap-1 text-sm">
                        <button data-lang="zh-CN" class="dp-lang-btn px-2 py-1 rounded hover:text-neonCyan transition-colors">ä¸­æ–‡</button>
                        <span class="text-white/30">|</span>
                        <button data-lang="en-US" class="dp-lang-btn px-2 py-1 rounded hover:text-neonCyan transition-colors">EN</button>
                    </div>
                    <a href="/diary/list" class="text-white/70 hover:text-white transition-colors">
                        <i class="fa-solid fa-list mr-1"></i>
                        <span data-i18n="diary.backToList">è¿”å›åˆ—è¡¨</span>
                    </a>
                    <a href="/profile" class="text-white/70 hover:text-neonCyan transition-colors flex items-center gap-1">
                        <i class="fa-solid fa-user-circle text-neonCyan"></i>
                        <span class="hidden sm:inline" data-i18n="common.profile">ä¸ªäººä¸»é¡µ</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main class="pt-24 pb-12 px-4">
        <div class="max-w-2xl mx-auto">

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingState" class="text-center py-16">
                <div class="dp-loading-spinner mx-auto mb-4"></div>
                <p class="text-white/50" data-i18n="common.loading">åŠ è½½ä¸­...</p>
            </div>

            <!-- é”™è¯¯çŠ¶æ€ -->
            <div id="errorState" class="hidden text-center py-16">
                <i class="fa-solid fa-exclamation-triangle text-6xl text-conanRed/50 mb-4"></i>
                <p class="text-white/50 mb-4" data-i18n="diary.notFound">æ—¥è®°ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</p>
                <a href="/diary/list" class="inline-block px-6 py-3 rounded-lg bg-gradient-to-r from-neonCyan to-detectiveGold text-mysteryBlack font-bold">
                    <i class="fa-solid fa-arrow-left mr-2"></i>
                    <span data-i18n="diary.backToList">è¿”å›åˆ—è¡¨</span>
                </a>
            </div>

            <!-- æ—¥è®°è¯¦æƒ… -->
            <div id="diaryDetail" class="hidden">
                <!-- æ—¥æœŸå’Œå¿ƒæƒ… -->
                <div class="dp-container-card p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-4">
                            <div class="mood-display" id="moodEmoji">ğŸ“</div>
                            <div>
                                <div class="text-white/50 text-sm" data-i18n="diary.createdAt">åˆ›å»ºæ—¶é—´</div>
                                <div id="diaryDate" class="text-lg font-bold">-</div>
                            </div>
                        </div>
                        <button onclick="showDeleteModal()" class="dp-btn-danger px-4 py-2 rounded-lg text-conanRed">
                            <i class="fa-solid fa-trash-alt mr-1"></i>
                            <span data-i18n="diary.delete">åˆ é™¤</span>
                        </button>
                    </div>

                    <!-- æ—¥è®°å†…å®¹ -->
                    <div class="mb-6">
                        <h2 class="text-white/50 text-sm mb-2">
                            <i class="fa-solid fa-pen mr-1"></i>
                            <span data-i18n="diary.contentTitle">æ—¥è®°å†…å®¹</span>
                        </h2>
                        <div id="diaryContent" class="diary-content text-white/90 bg-black/20 rounded-lg p-4">
                            <!-- æ—¥è®°å†…å®¹ -->
                        </div>
                    </div>

                    <!-- AIå›å¤ -->
                    <div id="aiResponseSection">
                        <h2 class="text-white/50 text-sm mb-2">
                            <i class="fa-solid fa-comment mr-1"></i>
                            <span data-i18n="diary.aiResponseTitle">å°æŸ¯çš„å›å¤</span>
                        </h2>
                        <div class="dp-ai-response-box p-4">
                            <div class="flex items-start gap-3">
                                <div class="dp-ai-avatar">
                                    <i class="fa-solid fa-user-secret text-mysteryBlack text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="font-bold text-detectiveGold mb-2">å°æŸ¯</div>
                                    <div id="aiResponse" class="text-white/90 leading-relaxed">
                                        <!-- AIå›å¤å†…å®¹ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ— AIå›å¤ -->
                    <div id="noAiResponse" class="hidden text-center py-4">
                        <p class="text-white/50" data-i18n="diary.noAiResponse">å°æŸ¯è¿˜æ²¡æœ‰å›å¤è¿™ç¯‡æ—¥è®°</p>
                    </div>

                    <!-- ç›®æ ‡åˆ†æ -->
                    <div id="goalAnalysisSection" class="hidden mt-6">
                        <h2 class="text-white/50 text-sm mb-2">
                            <i class="fa-solid fa-bullseye mr-1"></i>
                            <span data-i18n="diary.goalAnalysisTitle">ç›®æ ‡è¿›åº¦åˆ†æ</span>
                        </h2>
                        <div class="dp-goal-analysis-box p-4 bg-gradient-to-br from-pink-500/10 to-purple-500/10 rounded-xl border border-pink-300/20">
                            <div id="goalAnalysisContent" class="text-white/90 leading-relaxed">
                                <!-- ç›®æ ‡åˆ†æå†…å®¹ï¼ˆMarkdownæ¸²æŸ“ï¼‰ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="flex gap-4">
                    <a href="/diary/list" class="flex-1 py-3 rounded-lg border border-white/20 text-white/70 hover:bg-white/10 transition-colors text-center">
                        <i class="fa-solid fa-arrow-left mr-2"></i>
                        <span data-i18n="diary.backToList">è¿”å›åˆ—è¡¨</span>
                    </a>
                    <a href="/diary" class="flex-1 py-3 rounded-lg bg-gradient-to-r from-neonCyan to-detectiveGold text-mysteryBlack font-bold text-center">
                        <i class="fa-solid fa-pen mr-2"></i>
                        <span data-i18n="diary.writeNew">å†™æ–°æ—¥è®°</span>
                    </a>
                </div>
            </div>

        </div>
    </main>

    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div id="deleteModal" class="fixed inset-0 z-50 hidden">
        <div class="dp-modal-overlay absolute inset-0" onclick="hideDeleteModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4 relative z-10">
            <div class="dp-modal-content relative p-6 max-w-sm w-full">
                <h3 class="text-xl font-bold mb-4 text-center">
                    <i class="fa-solid fa-exclamation-triangle text-conanRed mr-2"></i>
                    <span data-i18n="diary.deleteConfirmTitle">ç¡®è®¤åˆ é™¤</span>
                </h3>
                <p class="text-white/70 text-center mb-6" data-i18n="diary.deleteConfirmMessage">
                    åˆ é™¤åæ— æ³•æ¢å¤ï¼Œç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿ
                </p>
                <div class="flex gap-4">
                    <button onclick="hideDeleteModal()" class="flex-1 py-3 rounded-lg border border-white/20 text-white/70 hover:bg-white/10 transition-colors">
                        <span data-i18n="common.cancel">å–æ¶ˆ</span>
                    </button>
                    <button onclick="deleteDiary()" class="flex-1 py-3 rounded-lg bg-conanRed text-white font-bold hover:bg-conanRed/80 transition-colors">
                        <i class="fa-solid fa-trash-alt mr-2"></i>
                        <span data-i18n="diary.confirmDelete">ç¡®è®¤åˆ é™¤</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å›½é™…åŒ–æ”¯æŒ -->
    <script src="{{ url_for('static', filename='js/translations/zh-CN.js') }}"></script>
    <script src="{{ url_for('static', filename='js/translations/en-US.js') }}"></script>
    <script src="{{ url_for('static', filename='js/i18n.js') }}"></script>

    <script>
        const moodEmojis = ['', 'ğŸ˜¢', 'ğŸ˜•', 'ğŸ˜', 'ğŸ˜Š', 'ğŸ˜„'];
        let currentDiaryId = null;

        // ä»URLè·å–æ—¥è®°ID
        function getDiaryIdFromUrl() {
            const path = window.location.pathname;
            const match = path.match(/\/diary\/(\d+)/);
            return match ? parseInt(match[1]) : null;
        }

        // è·å–å½“å‰è¯­è¨€ï¼ˆä» cookie è¯»å–ï¼Œä¸ä¾èµ– i18n æ¨¡å—ï¼‰
        function getCurrentLang() {
            const match = document.cookie.match(/(?:^|;\s*)lang=([^;]*)/);
            return match ? match[1] : 'zh-CN';
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const lang = getCurrentLang();

            if (lang === 'en-US') {
                return date.toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
            }
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        // åŠ è½½æ—¥è®°è¯¦æƒ…
        async function loadDiary() {
            currentDiaryId = getDiaryIdFromUrl();

            if (!currentDiaryId) {
                showError();
                return;
            }

            try {
                const response = await fetch(`/api/diary/${currentDiaryId}`);
                const data = await response.json();

                document.getElementById('loadingState').classList.add('hidden');

                if (!data.success) {
                    showError();
                    return;
                }

                const diary = data.diary;

                // æ˜¾ç¤ºæ—¥è®°è¯¦æƒ…
                document.getElementById('diaryDetail').classList.remove('hidden');

                // å¡«å……å†…å®¹
                document.getElementById('moodEmoji').textContent = moodEmojis[diary.mood_score] || 'ğŸ“';
                document.getElementById('diaryDate').textContent = formatDate(diary.created_at);
                document.getElementById('diaryContent').textContent = diary.content;

                // AIå›å¤
                if (diary.ai_response) {
                    document.getElementById('aiResponse').textContent = diary.ai_response;
                    document.getElementById('aiResponseSection').classList.remove('hidden');
                    document.getElementById('noAiResponse').classList.add('hidden');
                } else {
                    document.getElementById('aiResponseSection').classList.add('hidden');
                    document.getElementById('noAiResponse').classList.remove('hidden');
                }

                // ç›®æ ‡åˆ†æï¼ˆä½¿ç”¨Markdownæ¸²æŸ“ï¼‰
                if (diary.goal_analysis) {
                    const goalContent = document.getElementById('goalAnalysisContent');
                    if (typeof marked !== 'undefined') {
                        goalContent.innerHTML = marked.parse(diary.goal_analysis);
                    } else {
                        goalContent.textContent = diary.goal_analysis;
                    }
                    document.getElementById('goalAnalysisSection').classList.remove('hidden');
                } else {
                    document.getElementById('goalAnalysisSection').classList.add('hidden');
                }

            } catch (error) {
                console.error('Load diary error:', error);
                showError();
            }
        }

        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        function showError() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
        }

        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¼¹çª—
        function showDeleteModal() {
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        // éšè—åˆ é™¤ç¡®è®¤å¼¹çª—
        function hideDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
        }

        // åˆ é™¤æ—¥è®°
        async function deleteDiary() {
            if (!currentDiaryId) return;

            try {
                const response = await fetch(`/api/diary/${currentDiaryId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    window.location.href = '/diary/list';
                } else {
                    alert(data.message || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('Delete diary error:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }

            hideDeleteModal();
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadDiary();
        });
    </script>
</body>
</html>
